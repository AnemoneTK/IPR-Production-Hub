name: Backup Supabase to R2

on:
  schedule:
    - cron: "0 3 * * *" # à¸£à¸±à¸™à¸—à¸¸à¸à¸§à¸±à¸™à¸•à¸­à¸™à¸•à¸µ 3
  workflow_dispatch:

jobs:
  backup_and_upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ”¥ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸: à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ IPv4 à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Cannot assign address)
      - name: Force IPv4 for Supabase
        shell: bash
        env:
          DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # 1. à¸”à¸¶à¸‡ Hostname à¸­à¸­à¸à¸¡à¸²à¸ˆà¸²à¸ Connection String (à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ @ à¸à¸±à¸š :)
          # à¹€à¸Šà¹ˆà¸™ postgres://user:pass@db.xxxx.supabase.co:5432/... -> à¸ˆà¸°à¹„à¸”à¹‰ db.xxxx.supabase.co
          HOST=$(echo $DB_URL | sed -r 's/.*@([^:]+):.*/\1/')

          echo "Detected Host: $HOST"

          # 2. à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚ IP à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ IPv4 (A record) à¸‚à¸­à¸‡ Host à¸™à¸±à¹‰à¸™
          IPV4=$(dig +short A $HOST | head -n 1)

          echo "Resolved IPv4: $IPV4"

          if [ -n "$IPV4" ]; then
            # 3. à¹€à¸‚à¸µà¸¢à¸™à¸—à¸±à¸šà¸¥à¸‡ /etc/hosts à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰ Hostname à¸™à¸µà¹‰à¸§à¸´à¹ˆà¸‡à¹„à¸›à¸—à¸µà¹ˆ IPv4 à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
            echo "$IPV4 $HOST" | sudo tee -a /etc/hosts
            echo "âœ… Successfully mapped $HOST to $IPV4"
          else
            echo "âŒ Failed to resolve IPv4 address"
            exit 1
          fi

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump Database
        run: |
          FILENAME="backup-$(date +'%Y-%m-%d-%H%M').sql"

          # à¸•à¸­à¸™à¸™à¸µà¹‰ pg_dump à¸ˆà¸°à¸§à¸´à¹ˆà¸‡à¸œà¹ˆà¸²à¸™ IPv4 à¸—à¸µà¹ˆà¹€à¸£à¸²à¸šà¸±à¸‡à¸„à¸±à¸šà¹„à¸§à¹‰à¹à¸™à¹ˆà¸™à¸­à¸™
          pg_dump "${{ secrets.SUPABASE_DB_URL }}" -f "$FILENAME"

          ls -lh "$FILENAME"
          echo "BACKUP_FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Configure AWS CLI for Cloudflare R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto

      - name: Upload to R2
        run: |
          aws s3 cp ${{ env.BACKUP_FILENAME }} s3://${{ secrets.R2_BUCKET_NAME }}/database-backups/${{ env.BACKUP_FILENAME }} \
            --endpoint-url https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com

      - name: Cleanup
        if: always()
        run: |
          if [ -n "${{ env.BACKUP_FILENAME }}" ]; then
            rm -f ${{ env.BACKUP_FILENAME }}
          fi
